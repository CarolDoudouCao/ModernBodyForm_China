---
title: "Modern_Chinese_bodysize_proportion_z_transformed"
author: "DC"
date: "2025-04-03"
output: html_document
---
# Install packages
```{r, warning=FALSE}
options(repos = c(CRAN = "https://cloud.r-project.org"))

required_packages <- c(
  "tidyverse",     # dplyr, tidyr, ggplot2, stringr, etc.
  "sf",            # st_read, st_transform, geom_sf, as_Spatial
  "raster",        # raster(), extract(), mask(), rasterFromXYZ()
  "sp",            # SpatialPoints()
  "brms",          # brm(), bf(), priors
  "bayesplot",     # mcmc_areas(), mcmc_areas_ridges()
  "tidybayes",     # as_draws_df()
  "patchwork",     # plot_layout()
  "RColorBrewer",  # brewer.pal()
  "here"           # here()
)

# Install missing packages
install_missing <- required_packages[!required_packages %in% installed.packages()[, "Package"]]
if (length(install_missing) > 0) {
  install.packages(install_missing)
}
# Load packages quietly
invisible(lapply(required_packages, function(pkg) suppressMessages(library(pkg, character.only = TRUE))))
```

# 1. Data Preparation
```{r,warning=FALSE}
# Load data
groups <- read.csv("modern_multiple_groups.csv", stringsAsFactors = FALSE)

# Convert relevant columns to numeric
num_cols <- c("Stature", "Bodymass", "RSittinght", "RelativeBodyBreadth", "Longitude", "Latitude")
groups[num_cols] <- lapply(groups[num_cols], function(x) as.numeric(replace(x, x == "-", NA)))

# Remove rows with missing coordinates
groups <- groups %>% drop_na(Longitude, Latitude)

# Extract coordinates
coordinates <- groups %>% dplyr::select(Longitude, Latitude)

# Convert to spatial points
points <- SpatialPoints(coordinates)

# Load raster layers
climate_paths <- list(
  Mintemp   = "climatic data/wc2.1_30s_bio/wc2.1_30s_bio_6.tif",
  Maxtemp   = "climatic data/wc2.1_30s_bio/wc2.1_30s_bio_5.tif",
  Minprecip = "climatic data/wc2.1_30s_bio/wc2.1_30s_bio_14.tif",
  Maxprecip = "climatic data/wc2.1_30s_bio/wc2.1_30s_bio_13.tif",
  Altitude  = "climatic data/wc2.1_30s_elev.tif"
)
Mintemp_raster   <- raster("climatic data/wc2.1_30s_bio/wc2.1_30s_bio_6.tif")
Maxtemp_raster   <- raster("climatic data/wc2.1_30s_bio/wc2.1_30s_bio_5.tif")
Minprecip_raster <- raster("climatic data/wc2.1_30s_bio/wc2.1_30s_bio_14.tif")
Maxprecip_raster <- raster("climatic data/wc2.1_30s_bio/wc2.1_30s_bio_13.tif")
Altitude_raster  <- raster("climatic data/wc2.1_30s_elev.tif")

# Extract raster values
climate_data <- lapply(climate_paths, function(path) extract(raster(path), points))

# Add extracted climate variables to the dataset
groups <- bind_cols(groups, as.data.frame(climate_data))

# Keep only rows with complete climate data
groups <- groups %>% drop_na(Mintemp, Maxtemp, Minprecip, Maxprecip, Altitude)

# Keep groups with at least 3 individuals
groups <- groups %>% group_by(Langsubgroup) %>% filter(n() >= 3) %>% ungroup()

# Split data by sex
male_data   <- filter(groups, Sex == "M")
female_data <- filter(groups, Sex == "F")
```

# Set Mapping Parameters
```{r}
# Ensure SHX file restoration
Sys.setenv("SHAPE_RESTORE_SHX" = "YES")

# Load shapefile
chinashape <- st_read("bou1_4p.shp")
basemap_wgs84 <- st_transform(chinashape, crs = 4326)
basemap_sp_wgs84 <- as_Spatial(basemap_wgs84)


male_colors_z <- rev(brewer.pal(9, "RdBu"))
female_colors_z <- rev(brewer.pal(9, "PuOr"))

z_limits <- c(-2.1,2.1)

# Save scaling parameters for longitude and latitude
# Save scaling parameters for males
male_longitude_center <- attr(scale(male_data$Longitude), "scaled:center")
male_longitude_scale  <- attr(scale(male_data$Longitude), "scaled:scale")
male_latitude_center  <- attr(scale(male_data$Latitude), "scaled:center")
male_latitude_scale   <- attr(scale(male_data$Latitude), "scaled:scale")
male_mintemp_center   <- attr(scale(male_data$Mintemp), "scaled:center")
male_mintemp_scale    <- attr(scale(male_data$Mintemp), "scaled:scale")
male_maxtemp_center   <- attr(scale(male_data$Maxtemp), "scaled:center")
male_maxtemp_scale    <- attr(scale(male_data$Maxtemp), "scaled:scale")
male_minprecip_center <- attr(scale(male_data$Minprecip), "scaled:center")
male_minprecip_scale  <- attr(scale(male_data$Minprecip), "scaled:scale")
male_maxprecip_center <- attr(scale(male_data$Maxprecip), "scaled:center")
male_maxprecip_scale  <- attr(scale(male_data$Maxprecip), "scaled:scale")
male_altitude_center  <- attr(scale(male_data$Altitude), "scaled:center")
male_altitude_scale   <- attr(scale(male_data$Altitude), "scaled:scale")

# Save scaling parameters for females
female_longitude_center <- attr(scale(female_data$Longitude), "scaled:center")
female_longitude_scale  <- attr(scale(female_data$Longitude), "scaled:scale")
female_latitude_center  <- attr(scale(female_data$Latitude), "scaled:center")
female_latitude_scale   <- attr(scale(female_data$Latitude), "scaled:scale")
female_mintemp_center   <- attr(scale(female_data$Mintemp), "scaled:center")
female_mintemp_scale    <- attr(scale(female_data$Mintemp), "scaled:scale")
female_maxtemp_center   <- attr(scale(female_data$Maxtemp), "scaled:center")
female_maxtemp_scale    <- attr(scale(female_data$Maxtemp), "scaled:scale")
female_minprecip_center <- attr(scale(female_data$Minprecip), "scaled:center")
female_minprecip_scale  <- attr(scale(female_data$Minprecip), "scaled:scale")
female_maxprecip_center <- attr(scale(female_data$Maxprecip), "scaled:center")
female_maxprecip_scale  <- attr(scale(female_data$Maxprecip), "scaled:scale")
female_altitude_center  <- attr(scale(female_data$Altitude), "scaled:center")
female_altitude_scale   <- attr(scale(female_data$Altitude), "scaled:scale")
```

# Male_stature
## Create the processed dataset with scaled predictors
```{r}
modern_male_stature <- male_data %>%
  filter(!is.na(Stature)) %>%    # Keep non-missing Stature values
  mutate(
    longitude_scaled   = as.numeric(scale(Longitude)[,1]),  # Scale Longitude
    latitude_scaled    = as.numeric(scale(Latitude)[,1]),   # Scale Latitude
    mintemp_scaled     = as.numeric(scale(Mintemp)[,1]),    # Scale Minimum Temperature
    maxtemp_scaled     = as.numeric(scale(Maxtemp)[,1]),    # Scale Maximum Temperature
    minprecip_scaled   = as.numeric(scale(Minprecip)[,1]),  # Scale Minimum Precipitation
    maxprecip_scaled   = as.numeric(scale(Maxprecip)[,1]),  # Scale Maximum Precipitation
    altitude_scaled    = as.numeric(scale(Altitude)[,1]),   # Scale Altitude
    stature_z          = as.numeric(scale(Stature)[,1])     # Scale Stature (response variable)
  )
sd(modern_male_stature$Stature)
```

## Define the model formula
```{r}
# - Predict stature_z using:
#     - a smooth spatial term (longitude × latitude interaction)
#     - Time period and Urbanism
#     - Climatic predictors (scaled)
#     - Random intercepts and slopes for Time by Langsubgroup
male_stature_formula_z <- bf(
  stature_z ~ t2(longitude_scaled, latitude_scaled) + 
    Time + Urbanism +
    mintemp_scaled + maxtemp_scaled + 
    minprecip_scaled + maxprecip_scaled + 
    altitude_scaled + (1 + Time | Langsubgroup)
)
```

## Fit the model 
```{r}
# - Student's t likelihood for robustness against outliers
# - Weakly informative priors to regularize estimates
# - Save all posterior draws for later use (save_pars)
fit_modern_male_stature_z <- brm(
  formula = male_stature_formula_z,
  data = modern_male_stature,
  family = student(),  # Student-t distribution
  prior = c(
    prior(normal(0, 1), class = Intercept),           # Prior for Intercept
    prior(normal(0, 1), class = b),                   # Prior for fixed effects
    prior(cauchy(0, 1), class = sigma),               # Prior for residual error
    prior(cauchy(0, 1), class = sd, group = "Langsubgroup"), # Prior for random effects
    prior(gamma(2, 0.2), class = nu)                  # Prior for Student-t degrees of freedom
  ),
  iter = 4000, warmup = 1000, chains = 4, cores = 4,  # MCMC settings
  control = list(adapt_delta = 0.99),                 # Increase adapt_delta for better convergence
  save_pars = save_pars(all = TRUE)                   # Save full posterior for future use
)

# Display model summary
summary(fit_modern_male_stature_z)
```

##  Posterior Extraction 
```{r, warning=FALSE}
# Extract posterior draws as a data frame:
post_draws_male_stature_z <- as_draws_df(fit_modern_male_stature_z)

# Extract fixed effects (parameters starting with "b_")
fixef_male_stature_z <- post_draws_male_stature_z[, grepl("^b_", colnames(post_draws_male_stature_z))]

# Remove the intercept parameter
fixef_male_stature_no_int <- fixef_male_stature_z[, !grepl("Intercept", colnames(fixef_male_stature_z))]

# Extract random effects (e.g., for Langsubgroup)
raneff_male_stature_z <- post_draws_male_stature_z[, grepl("^r_Langsubgroup", colnames(post_draws_male_stature_z))]
```

### Fixed effects density plots (excluding intercept) 

```{r}
# 1) helper to clean up names
clean_labels <- function(x) {
  x %>%
    str_remove("^b_") %>%          # drop 'b_' prefix
    str_remove("^Urbanism") %>%    # drop 'Urbanism' if it’s at the start
    str_remove("_scaled$") %>%     # drop '_scaled' suffix
    str_to_sentence()              # capitalize first letter
}

# 2) compute means
fixed_male_stature_z <- colnames(fixef_male_stature_no_int)
means_male_stature_z <- apply(fixef_male_stature_no_int, 2, mean)
means_male_stature_df_z <- data.frame(
  parameter = fixed_male_stature_z,
  mean      = means_male_stature_z,
  stringsAsFactors = FALSE
)

# 3) clean the column names *and* the means labels
colnames(fixef_male_stature_no_int) <- clean_labels(colnames(fixef_male_stature_no_int))
means_male_stature_df_z$parameter   <- clean_labels(means_male_stature_df_z$parameter)

# 4) plot
p_fixed_male_stature_z <- mcmc_areas_ridges(
  fixef_male_stature_no_int,
  regex_pars = ".*",    # now match every cleaned name
  prob       = 0.95
) +
  labs(
    title = "Male Stature",
    x     = "Estimate",
    y     = "Coefficient"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title   = element_text(color = "darkblue", size = 12, face = "bold"),
    axis.title.x = element_text(color = "black", size = 12),
    axis.text    = element_text(color = "black", size = 12)
  ) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red", linewidth = 0.8) +
  geom_point(
    data     = means_male_stature_df_z,
    aes(x = mean, y = parameter),
    shape    = 124, size = 3, color = "blue",
    position = position_nudge(y = 0.5)
  )

# display
p_fixed_male_stature_z

```

### Random effects density plot
```{r}
clean_random_labels <- function(x) {
  x %>%
    sub("^r_Langsubgroup\\[", "", .) %>%  # drop opening
    sub("\\]$", "", .)  %>%  
    sub(",Intercept$", "", .) %>% 
    sub(",TimeLate$", "", .) # drop closing
}
random_intercept_male_stature_z <- grep("Intercept", colnames(raneff_male_stature_z), value = TRUE)
random_slope_male_stature_z     <- grep("TimeLate", colnames(raneff_male_stature_z), value = TRUE)
random_slope_male_stature_z <- random_slope_male_stature_z[
  !grepl("Austronesian", random_slope_male_stature_z)
]
# Plot for random intercepts
## visualizing for each language subgroup whether its baseline stature (at average longitude/latitude, the “Early” period, average climate, etc.) sits above or below the grand mean.
p_random_intercepts_male_stature_z <- mcmc_areas(
  raneff_male_stature_z,
  pars = random_intercept_male_stature_z,
  prob = 0.95  # 95% confidence intervals
) +
  scale_y_discrete(labels = clean_random_labels) +
  labs(
    x = "Random Intercept: Baseline Deviation (Male Stature Z)"
  ) +
  theme_minimal(base_size = 12) +
  # Mark zero with a vertical dashed red line using linewidth instead of size
  geom_vline(xintercept = 0, linetype = "dashed", color = "red", linewidth = 0.2)

# Plot for random slopes for Time
# Random slope r_Langsubgroup[<group>,TimeLate] is each subgroup’s deviation from that average Late–Early effect.
p_random_slopes_male_stature_z <- mcmc_areas(
  raneff_male_stature_z,
  pars = random_slope_male_stature_z,
  prob = 0.95
) +  
  scale_y_discrete(labels = clean_random_labels) +
  labs(
    x = "Random Slope: Late vs Early Period (Male Stature Z)"
  ) +
  theme_minimal(base_size = 12) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red", linewidth = 0.2)
print(p_random_intercepts_male_stature_z)
print(p_random_slopes_male_stature_z)

# 5b) Or arrange side‑by‑side:
(p_random_intercepts_male_stature_z | p_random_slopes_male_stature_z) +
  plot_layout(ncol = 2, widths = c(1, 1)) &
  theme(plot.margin = margin(5, 5, 5, 5))
```

## Male_stature_prediction (Early Rural)
```{r}
# 1. Create a full geographic grid over the study area using Longitude & Latitude for mapping.
grid_geo <- expand.grid(
  Longitude = seq(70, 140, length.out = 400),
  Latitude  = seq(10, 60, length.out = 400)
)

# 2. Split the grid into 20 equal chunks.
num_chunks <- 20
grid_segments <- split(grid_geo, cut(seq_len(nrow(grid_geo)), breaks = num_chunks, labels = FALSE))

# Predict over spatial grid using correct model
predictions_list <- list()

for (i in seq_along(grid_segments)) {
  cat("Processing chunk", i, "of", length(grid_segments), "\n")
  
  grid_chunk <- grid_segments[[i]]
  
  # Extract raster values
  grid_chunk <- grid_chunk %>%
    mutate(
      Mintemp      = extract(Mintemp_raster, cbind(Longitude, Latitude)),
      Maxtemp      = extract(Maxtemp_raster, cbind(Longitude, Latitude)),
      Minprecip    = extract(Minprecip_raster, cbind(Longitude, Latitude)),
      Maxprecip    = extract(Maxprecip_raster, cbind(Longitude, Latitude)),
      Altitude_abs = extract(Altitude_raster, cbind(Longitude, Latitude))
    ) %>%
    mutate(
      Time     = factor("Early", levels = c("Early", "Late")),
      Urbanism = factor("Rural", levels = c("Rural", "Urban")),
      
      # Scale using saved male parameters
      mintemp_scaled   = (Mintemp      - male_mintemp_center)   / male_mintemp_scale,
      maxtemp_scaled   = (Maxtemp      - male_maxtemp_center)   / male_maxtemp_scale,
      minprecip_scaled = (Minprecip    - male_minprecip_center) / male_minprecip_scale,
      maxprecip_scaled = (Maxprecip    - male_maxprecip_center) / male_maxprecip_scale,
      altitude_scaled  = (Altitude_abs - male_altitude_center)  / male_altitude_scale,
      longitude_scaled = (Longitude    - male_longitude_center) / male_longitude_scale,
      latitude_scaled  = (Latitude     - male_latitude_center)  / male_latitude_scale
    )
  
  # Predict from model (fixed effects only)
  seg_predictions <- predict(
    fit_modern_male_stature_z,
    newdata = grid_chunk,
    re_formula = ~0
  )
  
  grid_chunk$Stature_pred_z <- seg_predictions[, "Estimate"]
  predictions_list[[i]] <- grid_chunk
  rm(grid_chunk)
  gc()
}

# Combine and save
final_predictions_male_z <- do.call(rbind, predictions_list)

write.csv(
  final_predictions_male_z,
  file = here("output", "final_male_stature_predictions_20chunks_z_early_rural.csv"),
  row.names = FALSE
)

cat("Grid prediction complete and saved.\n")
```

## Male_stature_prediction (Late Urban)
```{r}
# 1. Create a full geographic grid over the study area using Longitude & Latitude for mapping.
grid_geo <- expand.grid(
  Longitude = seq(70, 140, length.out = 400),
  Latitude  = seq(10, 60, length.out = 400)
)

# 2. Split the grid into 20 equal chunks.
num_chunks <- 20
grid_segments <- split(grid_geo, cut(seq_len(nrow(grid_geo)), breaks = num_chunks, labels = FALSE))

# Predict over spatial grid using correct model
predictions_list <- list()

for (i in seq_along(grid_segments)) {
  cat("Processing chunk", i, "of", length(grid_segments), "\n")
  
  grid_chunk <- grid_segments[[i]]
  
  # Extract raster values
  grid_chunk <- grid_chunk %>%
    mutate(
      Mintemp      = extract(Mintemp_raster, cbind(Longitude, Latitude)),
      Maxtemp      = extract(Maxtemp_raster, cbind(Longitude, Latitude)),
      Minprecip    = extract(Minprecip_raster, cbind(Longitude, Latitude)),
      Maxprecip    = extract(Maxprecip_raster, cbind(Longitude, Latitude)),
      Altitude_abs = extract(Altitude_raster, cbind(Longitude, Latitude))
    ) %>%
    mutate(
      Time     = factor("Late", levels = c("Early", "Late")),
      Urbanism = factor("Urban", levels = c("Rural", "Urban")),
      
      # Scale using saved male parameters
      mintemp_scaled   = (Mintemp      - male_mintemp_center)   / male_mintemp_scale,
      maxtemp_scaled   = (Maxtemp      - male_maxtemp_center)   / male_maxtemp_scale,
      minprecip_scaled = (Minprecip    - male_minprecip_center) / male_minprecip_scale,
      maxprecip_scaled = (Maxprecip    - male_maxprecip_center) / male_maxprecip_scale,
      altitude_scaled  = (Altitude_abs - male_altitude_center)  / male_altitude_scale,
      longitude_scaled = (Longitude    - male_longitude_center) / male_longitude_scale,
      latitude_scaled  = (Latitude     - male_latitude_center)  / male_latitude_scale
    )
  
  # Predict from model (fixed effects only)
  seg_predictions <- predict(
    fit_modern_male_stature_z,
    newdata = grid_chunk,
    re_formula = ~0
  )
  
  grid_chunk$Stature_pred_z <- seg_predictions[, "Estimate"]
  predictions_list[[i]] <- grid_chunk
  rm(grid_chunk)
  gc()
}

# Combine and save
final_predictions_male_z <- do.call(rbind, predictions_list)

write.csv(
  final_predictions_male_z,
  file = here("output", "final_male_stature_predictions_20chunks_z_late_urban.csv"),
  row.names = FALSE
)

cat("Grid prediction complete and saved.\n")
```

### Predict male_stature_coordonly (Early Rural)
```{r}
# Create geographic grid (if not done already)
grid_male_stature_coordonly <- expand.grid(
  Longitude = seq(70, 140, length.out = 400),
  Latitude  = seq(10, 60, length.out = 400)
)

# Split into chunks
num_chunks <- 20
grid_male_chunks <- split(grid_male_stature_coordonly, 
                          cut(seq_len(nrow(grid_male_stature_coordonly)), 
                              breaks = num_chunks, labels = FALSE))

predictions_coordonly_list <- list()

for (i in seq_along(grid_male_chunks)) {
  cat("Processing coordinate-only chunk", i, "of", length(grid_male_chunks), "\n")
  
  grid_chunk <- grid_male_chunks[[i]] %>%
    mutate(
      # Scale coordinates
      longitude_scaled = (Longitude - male_longitude_center) / male_longitude_scale,
      latitude_scaled  = (Latitude  - male_latitude_center)  / male_latitude_scale,
      
      # Neutral values for env predictors
      mintemp_scaled    = 0,
      maxtemp_scaled    = 0,
      minprecip_scaled  = 0,
      maxprecip_scaled  = 0,
      altitude_scaled   = 0,
      
      # Categorical controls
      Time     = factor("Early", levels = c("Early", "Late")),
      Urbanism = factor("Rural", levels = c("Rural", "Urban"))
    )
  
  # Predict from full model (spatial-only, env = 0)
  chunk_pred <- predict(
     fit_modern_male_stature_z,
    newdata = grid_chunk,
    re_formula = ~0  # fixed effects only
  )
  
  grid_chunk$Stature_pred_z <- chunk_pred[, "Estimate"]
  predictions_coordonly_list[[i]] <- grid_chunk
  
  rm(grid_chunk)
  gc()
}
df_male_stature_coordonly_z <- do.call(rbind, predictions_coordonly_list)

# Save if you like
write.csv(df_male_stature_coordonly_z,
          here("output", "male_stature_pred_coordonly_chunks_z_early_rural.csv"),
          row.names = FALSE)

cat("Coordinate-only prediction complete!\n")
```

### Predict male_stature_coordonly (Late Urban)
```{r}
# Create geographic grid (if not done already)
grid_male_stature_coordonly <- expand.grid(
  Longitude = seq(70, 140, length.out = 400),
  Latitude  = seq(10, 60, length.out = 400)
)

# Split into chunks
num_chunks <- 20
grid_male_chunks <- split(grid_male_stature_coordonly, 
                          cut(seq_len(nrow(grid_male_stature_coordonly)), 
                              breaks = num_chunks, labels = FALSE))

predictions_coordonly_list <- list()

for (i in seq_along(grid_male_chunks)) {
  cat("Processing coordinate-only chunk", i, "of", length(grid_male_chunks), "\n")
  
  grid_chunk <- grid_male_chunks[[i]] %>%
    mutate(
      # Scale coordinates
      longitude_scaled = (Longitude - male_longitude_center) / male_longitude_scale,
      latitude_scaled  = (Latitude  - male_latitude_center)  / male_latitude_scale,
      
      # Neutral values for env predictors
      mintemp_scaled    = 0,
      maxtemp_scaled    = 0,
      minprecip_scaled  = 0,
      maxprecip_scaled  = 0,
      altitude_scaled   = 0,
      
      # Categorical controls
      Time     = factor("Late", levels = c("Early", "Late")),
      Urbanism = factor("Urban", levels = c("Rural", "Urban"))
    )
  
  # Predict from full model (spatial-only, env = 0)
  chunk_pred <- predict(
    fit_modern_male_stature_z,
    newdata = grid_chunk,
    re_formula = ~0  # fixed effects only
  )
  
  grid_chunk$Stature_pred_z <- chunk_pred[, "Estimate"]
  predictions_coordonly_list[[i]] <- grid_chunk
  
  rm(grid_chunk)
  gc()
}
df_male_stature_coordonly_z <- do.call(rbind, predictions_coordonly_list)

# Save if you like
write.csv(df_male_stature_coordonly_z,
          here("output", "male_stature_pred_coordonly_chunks_z_late_urban.csv"),
          row.names = FALSE)

cat("Coordinate-only prediction complete!\n")
```

### Visual full-Early Rural
```{r}
# Read the predicted male stature CSV (with z-scored predictions)
extended_grid_male_stature <- read.csv(here("output", "final_male_stature_predictions_20chunks_z_with_coordinates_early_rural.csv"))

# Average the z-scored predictions across all Time and Urbanism to capture overall spatial trends
spatial_trends_male_stature <- extended_grid_male_stature %>%
  group_by(Longitude, Latitude) %>%
  summarise(
    Stature_z = mean(Stature_pred_z, na.rm = TRUE)
  ) %>%
  ungroup()

# Create a raster from the averaged z-scored predictions (using Longitude, Latitude, and Stature_z)
rast_z_male_stature <- rasterFromXYZ(spatial_trends_male_stature[, c("Longitude", "Latitude", "Stature_z")])

# Mask the raster with the basemap (basemap_sp_wgs84 should be an sf or Spatial* object)
rast_z_masked_male_stature <- mask(rast_z_male_stature, basemap_sp_wgs84)
crs(rast_z_masked_male_stature) <- CRS("+proj=longlat +datum=WGS84")

# Convert the masked raster to a data frame for plotting
spatial_trends_z_male_stature <- as.data.frame(rasterToPoints(rast_z_masked_male_stature), stringsAsFactors = FALSE)
colnames(spatial_trends_z_male_stature) <- c("Longitude", "Latitude", "Stature_z")


# Create the ggplot for spatial trends (predicted z-scores)
p_spatial_male_stature_trends_z <- ggplot(spatial_trends_z_male_stature, 
                              aes(x = Longitude, y = Latitude, fill = Stature_z)) +
  geom_raster() +
  geom_sf(data = st_boundary(basemap_wgs84), 
          inherit.aes = FALSE, 
          color = "darkgray", 
          linewidth = 1) +
  # Add original sites as points
  geom_point(data = modern_male_stature, 
             mapping = aes(x = Longitude, y = Latitude), 
             size = 0.8, 
             shape = 24, 
             fill = "red", 
             color = "white", 
             stroke = 0.5,
             inherit.aes = FALSE) +
  scale_fill_gradientn(
    colors = male_colors_z,          # custom color palette
    limits = z_limits,       # predefined or calculated limits
    name = "Stature (z-score)",
    na.value = "transparent"
  ) +
  coord_sf(xlim = c(70, 140), ylim = c(10, 60), expand = FALSE) +
  labs(
    title = "Spatial Trends of Predicted Male Stature (Z-Scored)",
    x = "Longitude", 
    y = "Latitude"
  ) +
  theme_minimal() +
  theme(
    plot.margin     = margin(3, 4, 3, 4, unit = "pt"),
    legend.position = "right",
    plot.title      = element_text(size = 12, face = "bold"),
    axis.title      = element_text(size = 12),
    axis.text       = element_text(size = 10),
    legend.title    = element_text(size = 10),
    legend.text     = element_text(size = 10)
  )

# Show and save the plot
print(p_spatial_male_stature_trends_z)
```

### Coordinates only visual (early rural)
```{r, warning=FALSE}
# Read prediction from coordinate-only chunks (z-scored)
df_male_stature_coordonly_z <- read.csv(here("output", "male_stature_pred_coordonly_chunks_z_early_rural.csv"))

# Optional check
head(df_male_stature_coordonly_z)
# Rename just in case
colnames(df_male_stature_coordonly_z)[colnames(df_male_stature_coordonly_z) == "Stature_pred_z"] <- "Stature_z"
# Convert to raster
rast_male_stature_coordonly_z <- rasterFromXYZ(
  df_male_stature_coordonly_z[, c("Longitude", "Latitude", "Stature_z")]
)

# Mask using shapefile
rast_male_stature_coordonly_z <- mask(rast_male_stature_coordonly_z, basemap_sp_wgs84)
crs(rast_male_stature_coordonly_z) <- CRS("+proj=longlat +datum=WGS84")
df_male_stature_coordonly_z_plot <- as.data.frame(
  rasterToPoints(rast_male_stature_coordonly_z),
  stringsAsFactors = FALSE
)

colnames(df_male_stature_coordonly_z_plot) <- c("Longitude", "Latitude", "Stature_z")
plot_male_stature_coordonly_z_early_rural <- ggplot(df_male_stature_coordonly_z_plot, 
                                        aes(x = Longitude, y = Latitude, fill = Stature_z)) +
  geom_raster() +
  geom_sf(data = st_boundary(basemap_wgs84), 
          inherit.aes = FALSE,  
          color = "darkgray", 
          linewidth = 1) +
  scale_fill_gradientn(
    colors = male_colors_z,
    limits = z_limits,
    name = "Stature (z-score)",
    na.value = "transparent"
  ) +
  # Add original sites as points
  geom_point(data = modern_male_stature, 
             mapping = aes(x = Longitude, y = Latitude), 
             size = 0.8, 
             shape = 24, 
             fill = "red", 
             color = "white", 
             stroke = 0.5,
             inherit.aes = FALSE) +
  coord_sf(xlim = c(70, 140), ylim = c(10, 60), expand = FALSE) +
  labs(
    title = "Residual Spatial Pattern in Predicted Male Stature (Z-Score)",
    subtitle = "Predicted with Spatial Coordinates Only (Env Held Constant)",
    x = "Longitude", y = "Latitude"
  ) +
  theme_minimal() +
  theme(
    plot.margin     = margin(3, 4, 3, 4, unit = "pt"),
    legend.position = "right",
    plot.title      = element_text(size = 12, face = "bold"),
    axis.title      = element_text(size = 12),
    axis.text       = element_text(size = 10),
    legend.title    = element_text(size = 10),
    legend.text     = element_text(size = 10)
  )

# Print the plot
plot_male_stature_coordonly_z_early_rural
```

### Comparing "Full model" vs "Coordinate-only" prediction (Early_rural)
```{r,warning=FALSE}
# Merge full prediction and coordinate-only prediction
comparison_male_stature_z <- extended_grid_male_stature %>%
 dplyr::select(Longitude, Latitude, Stature_z_full = Stature_pred_z) %>%
  inner_join(
    df_male_stature_coordonly_z %>%
      dplyr::select(Longitude, Latitude, Stature_z_coordonly = Stature_z),
    by = c("Longitude", "Latitude")
  ) %>%
  mutate(
    Env_effect = Stature_z_full - Stature_z_coordonly
  )
comparison_male_stature_z <- comparison_male_stature_z %>%
  filter(!is.na(Stature_z_full) & !is.na(Stature_z_coordonly) & !is.na(Env_effect))

# 1. Build individual rasters
r_full_male_stature   <- rasterFromXYZ(comparison_male_stature_z[, c("Longitude","Latitude","Stature_z_full")])
r_coord_male_stature  <- rasterFromXYZ(comparison_male_stature_z[, c("Longitude","Latitude","Stature_z_coordonly")])
r_env_male_stature    <- rasterFromXYZ(comparison_male_stature_z[, c("Longitude","Latitude","Env_effect")])

# 2. Stack and mask in one go
r_stack_male_stature <- stack(r_full_male_stature, r_coord_male_stature, r_env_male_stature)
names(r_stack_male_stature) <- c("Stature_z_full","Stature_z_coordonly","Env_effect")
r_stack_masked_male_stature <- mask(r_stack_male_stature, basemap_sp_wgs84)

# 3. Back to a tibble
df_masked_male_stature <- as.data.frame(rasterToPoints(r_stack_masked_male_stature)) %>%
  rename(Longitude = x, Latitude = y)

# 4. Classify strong vs. weak effects
comparison_male_stature_z_masked <- df_masked_male_stature %>%
  mutate(
    Env_effect_category = if_else(abs(Env_effect) >= 0.3, "Strong", "Weak")
  )

# reshape for the three panels
comparison_male_stature_long_z_masked <- comparison_male_stature_z_masked %>%
  pivot_longer(c(Stature_z_full, Stature_z_coordonly, Env_effect),
               names_to="Model", values_to="Stature_z") %>%
  mutate(Model = factor(Model,
    levels = c("Stature_z_full","Stature_z_coordonly","Env_effect"),
    labels = c(
      "A. Full (Space + Environment)",
      "B. Space Only",
      "C. Environment Only"
    )
  ))

p_male_stature_comparison_z_early_rural <- ggplot(comparison_male_stature_long_z_masked, 
                     aes(x = Longitude, y = Latitude, fill = Stature_z)) +
  geom_raster() +
  geom_sf(data = st_boundary(basemap_wgs84), inherit.aes = FALSE,
          color = "grey", linewidth = 0.3) +
  facet_wrap(~Model, ncol = 3) +
  scale_fill_gradientn(
    colors = male_colors_z,
    limits = z_limits,
    name = "z-score",
    na.value = "transparent"
  ) +
     # Add original sites as points
  geom_point(data = modern_male_stature, 
             mapping = aes(x = Longitude, y = Latitude), 
             size = 0.2, 
             shape = 24, 
             fill = "red", 
             color = "red", 
             stroke = 0.1,
             inherit.aes = FALSE) +
     scale_x_continuous(
      breaks = seq(70, 140, by = 20))+
  coord_sf(xlim = c(70, 140), ylim = c(10, 60), expand = FALSE) +
  labs(
    x = "Longitude", y = "Latitude"
  ) +
  theme_minimal() +
  theme(
    plot.margin = margin(3, 4, 3, 4, unit = "pt"),
    strip.text = element_text(size = 7, face = "bold"),
    plot.title = element_text(size = 7, face = "bold"),
    axis.title = element_text(size = 7),
    axis.text = element_text(size = 7),
    legend.title = element_text(size = 7),
    legend.text = element_text(size = 7)
  )

p_male_stature_comparison_z_early_rural
```

### Visual Full- Late Urban
```{r}
# Read the predicted male stature CSV (with z-scored predictions)
extended_grid_male_stature <- read.csv(here("output", "final_male_stature_predictions_20chunks_z_late_urban.csv"))

# Average the z-scored predictions across all Time and Urbanism to capture overall spatial trends
spatial_trends_male_stature <- extended_grid_male_stature %>%
  group_by(Longitude, Latitude) %>%
  summarise(
    Stature_z = mean(Stature_pred_z, na.rm = TRUE)
  ) %>%
  ungroup()

# Create a raster from the averaged z-scored predictions (using Longitude, Latitude, and Stature_z)
rast_z_male_stature <- rasterFromXYZ(spatial_trends_male_stature[, c("Longitude", "Latitude", "Stature_z")])

# Mask the raster with the basemap (basemap_sp_wgs84 should be an sf or Spatial* object)
rast_z_masked_male_stature <- mask(rast_z_male_stature, basemap_sp_wgs84)
crs(rast_z_masked_male_stature) <- CRS("+proj=longlat +datum=WGS84")

# Convert the masked raster to a data frame for plotting
spatial_trends_z_male_stature <- as.data.frame(rasterToPoints(rast_z_masked_male_stature), stringsAsFactors = FALSE)
colnames(spatial_trends_z_male_stature) <- c("Longitude", "Latitude", "Stature_z")
# Create the ggplot for spatial trends (predicted z-scores)
p_spatial_male_stature_trends_z_late_urban <- ggplot(spatial_trends_z_male_stature, 
                              aes(x = Longitude, y = Latitude, fill = Stature_z)) +
  geom_raster() +
  geom_sf(data = st_boundary(basemap_wgs84), 
          inherit.aes = FALSE, 
          color = "darkgray", 
          linewidth = 1) +
  # Add original sites as points
  geom_point(data = modern_male_stature, 
             mapping = aes(x = Longitude, y = Latitude), 
             size = 0.8, 
             shape = 24, 
             fill = "red", 
             color = "white", 
             stroke = 0.5,
             inherit.aes = FALSE) +
  scale_fill_gradientn(
    colors = male_colors_z,          # custom color palette
    limits = z_limits,       # predefined or calculated limits
    name = "Stature (z-score)",
    na.value = "transparent"
  ) +
  coord_sf(xlim = c(70, 140), ylim = c(10, 60), expand = FALSE) +
  labs(
    title = "Spatial Trends of Predicted Male Stature (Z-Scored)",
    x = "Longitude", 
    y = "Latitude"
  ) +
  theme_minimal() +
  theme(
    plot.margin     = margin(3, 4, 3, 4, unit = "pt"),
    legend.position = "right",
    plot.title      = element_text(size = 12, face = "bold"),
    axis.title      = element_text(size = 12),
    axis.text       = element_text(size = 10),
    legend.title    = element_text(size = 10),
    legend.text     = element_text(size = 10)
  )

# Show and save the plot
print(p_spatial_male_stature_trends_z_late_urban)
```

### Coordinates only visual (late_urban)
```{r, warning=FALSE}
# Read prediction from coordinate-only chunks (z-scored)
df_male_stature_coordonly_z <- read.csv(here("output", "male_stature_pred_coordonly_chunks_z_late_urban.csv"))

# Optional check
head(df_male_stature_coordonly_z)
# Rename just in case
colnames(df_male_stature_coordonly_z)[colnames(df_male_stature_coordonly_z) == "Stature_pred_z"] <- "Stature_z"
# Convert to raster
rast_male_stature_coordonly_z <- rasterFromXYZ(
  df_male_stature_coordonly_z[, c("Longitude", "Latitude", "Stature_z")]
)

# Mask using shapefile
rast_male_stature_coordonly_z <- mask(rast_male_stature_coordonly_z, basemap_sp_wgs84)
crs(rast_male_stature_coordonly_z) <- CRS("+proj=longlat +datum=WGS84")
df_male_stature_coordonly_z_plot <- as.data.frame(
  rasterToPoints(rast_male_stature_coordonly_z),
  stringsAsFactors = FALSE
)

colnames(df_male_stature_coordonly_z_plot) <- c("Longitude", "Latitude", "Stature_z")
plot_male_stature_coordonly_z_late_urban <- ggplot(df_male_stature_coordonly_z_plot, 
                                        aes(x = Longitude, y = Latitude, fill = Stature_z)) +
  geom_raster() +
  geom_sf(data = st_boundary(basemap_wgs84), 
          inherit.aes = FALSE,  
          color = "darkgray", 
          linewidth = 1) +
  scale_fill_gradientn(
    colors = male_colors_z,
    limits = z_limits,
    name = "Stature (z-score)",
    na.value = "transparent"
  ) +
  # Add original sites as points
  geom_point(data = modern_male_stature, 
             mapping = aes(x = Longitude, y = Latitude), 
             size = 0.8, 
             shape = 24, 
             fill = "red", 
             color = "white", 
             stroke = 0.5,
             inherit.aes = FALSE) +
  coord_sf(xlim = c(70, 140), ylim = c(10, 60), expand = FALSE) +
  labs(
    title = "Residual Spatial Pattern in Predicted Male Stature (Z-Score)",
    subtitle = "Predicted with Spatial Coordinates Only (Env Held Constant)",
    x = "Longitude", y = "Latitude"
  ) +
  theme_minimal() +
  theme(
    plot.margin     = margin(3, 4, 3, 4, unit = "pt"),
    legend.position = "right",
    plot.title      = element_text(size = 12, face = "bold"),
    axis.title      = element_text(size = 12),
    axis.text       = element_text(size = 10),
    legend.title    = element_text(size = 10),
    legend.text     = element_text(size = 10)
  )

# Print the plot
plot_male_stature_coordonly_z_late_urban
```

### Comparing "Full model" vs "Coordinate-only" prediction (Late Urban)
```{r, warning=FALSE}
# Merge full prediction and coordinate-only prediction
comparison_male_stature_z <- extended_grid_male_stature %>%
 dplyr::select(Longitude, Latitude, Stature_z_full = Stature_pred_z) %>%
  inner_join(
    df_male_stature_coordonly_z %>%
      dplyr::select(Longitude, Latitude, Stature_z_coordonly = Stature_z),
    by = c("Longitude", "Latitude")
  ) %>%
  mutate(
    Env_effect = Stature_z_full - Stature_z_coordonly
  )
comparison_male_stature_z <- comparison_male_stature_z %>%
  filter(!is.na(Stature_z_full) & !is.na(Stature_z_coordonly) & !is.na(Env_effect))

# 1. Build individual rasters
r_full_male_stature   <- rasterFromXYZ(comparison_male_stature_z[, c("Longitude","Latitude","Stature_z_full")])
r_coord_male_stature  <- rasterFromXYZ(comparison_male_stature_z[, c("Longitude","Latitude","Stature_z_coordonly")])
r_env_male_stature    <- rasterFromXYZ(comparison_male_stature_z[, c("Longitude","Latitude","Env_effect")])

# 2. Stack and mask in one go
r_stack_male_stature <- stack(r_full_male_stature, r_coord_male_stature, r_env_male_stature)
names(r_stack_male_stature) <- c("Stature_z_full","Stature_z_coordonly","Env_effect")
r_stack_masked_male_stature <- mask(r_stack_male_stature, basemap_sp_wgs84)

# 3. Back to a tibble
df_masked_male_stature <- as.data.frame(rasterToPoints(r_stack_masked_male_stature)) %>%
  rename(Longitude = x, Latitude = y)

# 4. Classify strong vs. weak effects
comparison_male_stature_z_masked <- df_masked_male_stature %>%
  mutate(
    Env_effect_category = if_else(abs(Env_effect) >= 0.3, "Strong", "Weak")
  )

# reshape for the three panels
comparison_male_stature_long_z_masked <- comparison_male_stature_z_masked %>%
  pivot_longer(c(Stature_z_full, Stature_z_coordonly, Env_effect),
               names_to="Model", values_to="Stature_z") %>%
  mutate(Model = factor(Model,
    levels = c("Stature_z_full","Stature_z_coordonly","Env_effect"),
    labels = c(
      "A. Full (Space + Environment)",
      "B. Space Only",
      "C. Environment Only"
    )
  ))

p_male_stature_comparison_z_late_urban <- ggplot(comparison_male_stature_long_z_masked, 
                     aes(x = Longitude, y = Latitude, fill = Stature_z)) +
  geom_raster() +
  geom_sf(data = st_boundary(basemap_wgs84), inherit.aes = FALSE,
          color = "grey", linewidth = 0.3) +
  facet_wrap(~Model, ncol = 3) +
  scale_fill_gradientn(
    colors = male_colors_z,
    limits = z_limits,
    name = "z-score",
    na.value = "transparent"
  ) +
     # Add original sites as points
  geom_point(data = modern_male_stature, 
             mapping = aes(x = Longitude, y = Latitude), 
             size = 0.2, 
             shape = 24, 
             fill = "red", 
             color = "red", 
             stroke = 0.1,
             inherit.aes = FALSE) +
     scale_x_continuous(
      breaks = seq(70, 140, by = 20))+
  coord_sf(xlim = c(70, 140), ylim = c(10, 60), expand = FALSE) +
  labs(
    x = "Longitude", y = "Latitude"
  ) +
  theme_minimal() +
  theme(
    plot.margin = margin(3, 4, 3, 4, unit = "pt"),
    strip.text = element_text(size = 7, face = "bold"),
    plot.title = element_text(size = 7, face = "bold"),
    axis.title = element_text(size = 7),
    axis.text = element_text(size = 7),
    legend.title = element_text(size =7),
    legend.text = element_text(size = 7)
  )

p_male_stature_comparison_z_late_urban
```

###Conditional Effect - individual
#### Conditional Effect for Altitude
```{r, warning=FALSE}
# Extract conditional effect
ce_altitude_male_stature <- conditional_effects(fit_modern_male_stature_z, effects = "altitude_scaled")
p_altitude_male_stature <- plot(ce_altitude_male_stature, ask = FALSE)[["altitude_scaled"]]

# Get observed min and max
altitude_min_male_stature <- min(modern_male_stature$altitude_scaled, na.rm = TRUE)
altitude_max_male_stature <- max(modern_male_stature$altitude_scaled, na.rm = TRUE)

# Create “tick” plot
p_altitude_jitter_ticks_male_stature <- p_altitude_male_stature +
  # Highlight high-altitude region
  geom_rect(
    aes(xmin = 1.58, xmax = Inf, ymin = -Inf, ymax = Inf),
    fill = "lightblue", alpha = 0.01, inherit.aes = FALSE
  ) +
  geom_vline(xintercept = 1.58, linetype = "dotted", color = "blue") +
  annotate(
    "text", x = 2, y = max(p_altitude_male_stature$data$estimate__, na.rm = TRUE),
    label = "High Altitude (>2500m asl)", color = "blue", size = 4, hjust = 0
  ) +

  # —— bottom-only “ticks” using geom_jitter() ——  
  geom_jitter(
    data     = modern_male_stature,
    mapping  = aes(x = altitude_scaled, y = -Inf), # anchor at bottom
    inherit.aes = FALSE,
    shape    = 124,                               # vertical bar “|”
    size     = 3,                                 # thickness of the tick
    alpha    = 0.5,
    color    = "blue",
    position = position_jitter(width = 0.01, height = 0),
    clip     = "off"
  ) +
  coord_cartesian(clip = "off") +                # allow y = -Inf bars to show

  # Range markers
  geom_vline(xintercept = altitude_min_male_stature, linetype = "dashed", color = "salmon") +
  geom_vline(xintercept = altitude_max_male_stature, linetype = "dashed", color = "salmon") +
  annotate("text", x = altitude_min_male_stature, y = Inf, 
           label = paste("Min =", round(altitude_min_male_stature, 2)),
           hjust = 0, vjust = 2, color = "red", size = 4) +
  annotate("text", x = altitude_max_male_stature, y = Inf, 
           label = paste("Max =", round(altitude_max_male_stature, 2)),
           hjust = 1, vjust = 2, color = "red", size = 4) +

  # Labels
  labs(
    title = "Conditional Effect of Altitude",
    x     = "Scaled Altitude",
    y     = "Predicted Stature (Z-score)"
  )

print(p_altitude_jitter_ticks_male_stature)

modern_male_stature %>%
  filter(altitude_scaled > 1.58)
```

#### Conditional Effect for Minimum Temperature (mintemp_scaled)
```{r, warning=FALSE}
ce_mintemp_male_stature <- conditional_effects(fit_modern_male_stature_z, effects = "mintemp_scaled")
p_mintemp_male_stature <- plot(ce_mintemp_male_stature, ask = FALSE)[["mintemp_scaled"]]

# Extract range
temp_min_male_stature <- min(modern_male_stature$mintemp_scaled, na.rm = TRUE)
temp_max_male_stature <- max(modern_male_stature$mintemp_scaled, na.rm = TRUE)

p_mintemp_updated_male_stature <- p_mintemp_male_stature +
  geom_jitter(
    data     = modern_male_stature,
    mapping  = aes(x = mintemp_scaled, y = -Inf),      # anchor at bottom
    inherit.aes = FALSE,
    shape    = "|",                                     # vertical bar “|”
    size     = 3,                                       # thickness of your tick
    alpha    = 0.5,
    color    = "blue",
    position = position_jitter(width = 0.01, height = 0.1),  # only jitter in x
    clip     = "off"     
  )  +
  geom_vline(xintercept = temp_min_male_stature, linetype = "dashed", color = "salmon") +
  geom_vline(xintercept = temp_max_male_stature, linetype = "dashed", color = "salmon") +
  annotate("text", x = temp_min_male_stature, y = Inf, label = paste("Min =", round(temp_min_male_stature, 2)),
           hjust = 0, vjust = 2, color = "red", size = 4) +
  annotate("text", x = temp_max_male_stature, y = Inf, label = paste("Max =", round(temp_max_male_stature, 2)),
           hjust = 1, vjust = 2, color = "red", size = 4) +
  labs(
    title = "Conditional Effect of Mintemp",
    x = "Scaled Mintemp",
    y = "Predicted Stature (z-score)"
  ) +
  coord_cartesian(clip = "off")  # make sure the -Inf ticks are visible

print(p_mintemp_updated_male_stature)
```

#### Conditional Effect for Maximum Temperature (maxtemp_scaled)
```{r,warning=FALSE}
ce_maxtemp_male_stature <- conditional_effects(fit_modern_male_stature_z, effects = "maxtemp_scaled")
p_maxtemp_male_stature <- plot(ce_maxtemp_male_stature, ask = FALSE)[["maxtemp_scaled"]]

maxtemp_min_male_stature <- min(modern_male_stature$maxtemp_scaled, na.rm = TRUE)
maxtemp_max_male_stature <- max(modern_male_stature$maxtemp_scaled, na.rm = TRUE)

p_maxtemp_updated_male_stature <- p_maxtemp_male_stature +
  geom_jitter(
    data = modern_male_stature,
    mapping = aes(x = maxtemp_scaled, y = -Inf),      # anchor at bottom
    inherit.aes = FALSE,
    shape    = "|",                                     # vertical bar “|”
    size     = 3,                                       # thickness of your tick
    alpha    = 0.5,
    color    = "blue",
    position = position_jitter(width = 0.01, height = 0.1),  # only jitter in x
    clip     = "off"                                      # allow drawing on the panel edge
  ) +
  geom_vline(xintercept = maxtemp_min_male_stature, linetype = "dashed", color = "salmon") +
  geom_vline(xintercept = maxtemp_max_male_stature, linetype = "dashed", color = "salmon") +
  annotate("text", x = maxtemp_min_male_stature, y = Inf, label = paste("Min =", round(maxtemp_min_male_stature, 2)),
           hjust = 0, vjust = 2, color = "red", size = 4) +
  annotate("text", x = maxtemp_max_male_stature, y = Inf, label = paste("Max =", round(maxtemp_max_male_stature, 2)),
           hjust = 1, vjust = 2, color = "red", size = 4) +
  labs(
    title = "Conditional Effect of Maxtemp",
    x     = "Scaled Maxtemp",
    y     = "Predicted Stature (Z-score)"
  ) +
  coord_cartesian(clip = "off")  # make sure the -Inf ticks are visible

print(p_maxtemp_updated_male_stature)
```


####Conditional Effect for Minimum Precipitation (minprecip_scaled)
```{r, warning=FALSE}
ce_minprecip_male_stature <- conditional_effects(fit_modern_male_stature_z, effects = "minprecip_scaled")
p_minprecip_male_stature <- plot(ce_minprecip_male_stature, ask = FALSE)[["minprecip_scaled"]]

minprecip_min_male_stature <- min(modern_male_stature$minprecip_scaled, na.rm = TRUE)
minprecip_max_male_stature <- max(modern_male_stature$minprecip_scaled, na.rm = TRUE)

p_minprecip_updated_male_stature <- p_minprecip_male_stature +
  geom_jitter(
    data = modern_male_stature,
    mapping = aes(x = minprecip_scaled, y = -Inf),      # anchor at bottom
    inherit.aes = FALSE,
    shape    = "|",                                     # vertical bar “|”
    size     = 3,                                       # thickness of your tick
    alpha    = 0.5,
    color    = "blue",
    position = position_jitter(width = 0.01, height = 0.1),  # only jitter in x
    clip     = "off"                                      # allow drawing on the panel edge
  ) +
  geom_vline(xintercept = minprecip_min_male_stature, linetype = "dashed", color = "salmon") +
  geom_vline(xintercept = minprecip_max_male_stature, linetype = "dashed", color = "salmon") +
  annotate("text", x = minprecip_min_male_stature, y = Inf, label = paste("Min =", round(minprecip_min_male_stature, 2)),
           hjust = 0, vjust = 2, color = "red", size = 4) +
  annotate("text", x = minprecip_max_male_stature, y = Inf, label = paste("Max =", round(minprecip_max_male_stature, 2)),
           hjust = 1, vjust = 2, color = "red", size = 4) +
  labs(
    title = "Conditional Effect of Minprecip",
    x     = "Scaled Minprecip",
    y     = "Predicted Stature (Z-score)"
  ) +
  coord_cartesian(clip = "off")  # make sure the -Inf ticks are visible
print(p_minprecip_updated_male_stature)
```
#### Conditional Effect for Maximum Precipitation (maxprecip_scaled)
```{r}
ce_maxprecip_male_stature <- conditional_effects(fit_modern_male_stature_z, effects = "maxprecip_scaled")
p_maxprecip_male_stature <- plot(ce_maxprecip_male_stature, ask = FALSE)[["maxprecip_scaled"]]

maxprecip_min_male_stature <- min(modern_male_stature$maxprecip_scaled, na.rm = TRUE)
maxprecip_max_male_stature <- max(modern_male_stature$maxprecip_scaled, na.rm = TRUE)

p_maxprecip_updated_male_stature <- p_maxprecip_male_stature +
  geom_jitter(
    data = modern_male_stature,
    mapping = aes(x = maxprecip_scaled, y = -Inf),      # anchor at bottom
    inherit.aes = FALSE,
    shape    = "|",                                     # vertical bar “|”
    size     = 3,                                       # thickness of your tick
    alpha    = 0.5,
    color    = "blue",
    position = position_jitter(width = 0.01, height = 0.1),  # only jitter in x
    clip     = "off"                                      # allow drawing on the panel edge
  ) +
  geom_vline(xintercept = maxprecip_min_male_stature, linetype = "dashed", color = "salmon") +
  geom_vline(xintercept = maxprecip_max_male_stature, linetype = "dashed", color = "salmon") +
  annotate("text", x = maxprecip_min_male_stature, y = Inf, label = paste("Min =", round(maxprecip_min_male_stature, 2)),
           hjust = 0, vjust = 2, color = "red", size = 4) +
  annotate("text", x = maxprecip_max_male_stature, y = Inf, label = paste("Max =", round(maxprecip_max_male_stature, 2)),
           hjust = 1, vjust = 2, color = "red", size = 4) +
  labs(
    title = "Conditional Effect of Maxprecip",
    x = "Scaled Maxprecip",
    y = "Predicted Stature (Z-score)"
  )+
  coord_cartesian(clip = "off")  # make sure the -Inf ticks are visible

print(p_maxprecip_updated_male_stature)
```

#### Check the extereme cases
```{r}
modern_male_stature %>%
  filter(mintemp_scaled > 1.5)
modern_male_stature %>%
  filter(mintemp_scaled < - 2)
modern_male_stature %>%
  filter(maxtemp_scaled > 1)
modern_male_stature %>%
  filter(maxtemp_scaled < - 3)
modern_male_stature %>%
  filter(minprecip_scaled > 3)
modern_male_stature %>%
  filter(minprecip_scaled < 0)
modern_male_stature %>%
  filter(maxprecip_scaled > 3)
modern_male_stature %>%
  filter(maxprecip_scaled < -1)
```


